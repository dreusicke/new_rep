<!DOCTYPE HTML>
<html>
	<head>
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
		<meta charset="UTF-8">
		<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
		<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
		<link rel="stylesheet" type="text/css" href="css.css">
	</head>

	<body>
		<div id="story">
			<h1>Sense my city</h1>
			<h3>Projektbeschreibung</h3>
			<p>Hier steht unsere Geschichte.</p>
		</div>
		<img scr="/img/storyboard_2a.png" alt="Abbildung Storyboard 2a" width="200px" height="200px">
		<h3>Karte von Straßenlaternen in Berlin</h3>
		<form class="button">

			<input type="button" value="Show car traffic" class="button" onClick="alert('yes!');">
			<input type="button" value="Show car traffic really" class="button" onClick="cars">
			<input type="button" value="no function yet" class="button">
			<div id="tooltip" class="hidden">
				<p class="infobox">
				<table>
					<tbody>
						<tr><td class="thead" colspan="2">Details for street light</td></tr>
						<tr><td class="td_name">Name of the lamp</td><td class="td_data"><span id="name_lamp">dummie</span></td></tr>
						<tr><td class="td_name">Installation date</td><td class="td_data"><span id="installed">dummie</span></td></tr>
						<tr><td class="td_name">Bulb</td><td class="td_data"><span id="bulb">dummie</span></td></tr>
						<tr><td class="td_name">Type of bulb</td><td class="td_data"><span id="type_bulb">dummie</span></td></tr>
						<tr><td class="td_name">Power output in Watt</td><td class="td_data"><span id="watt">dummie</span></td></tr>
						<tr><td class="td_name">Energy consumption</td><td class="td_data"><span id="energy_consumption">dummie</span></td></tr>
						<tr><td class="td_name">Light output in Lumen</td><td class="td_data"><span id="lumen">dummie</span></td></tr>
						<tr><td class="td_name">Energy efficiency</td><td class="td_data"><span id="lumen_per_watt">dummie</span></td></tr>
						<tr><td class="td_name">Efficiency class</td><td class="td_data"><span id="energy_efficiency">dummie</span></td></tr>
						<tr><td class="td_name">Powered</td><td class="td_data"><span id="powered">dummie</span></td></tr>
					</tbody>
				</table>

				</p>
			</div>

		</form>

	<div id="map"></div>

	<h3>Nächste Visualisierung</h3>
	<p>Hier leiten wir über zur nächsten Visualisierung mit einigem Text Text Text Text Text Text Text Text Text Text Text Text Text Text Text Text Text Text Text Text Text Text Text . </p>
	</div>




<script type="text/javascript">


	//      CREATE GOOGLE MAP
//	var map = new google.maps.Map(document.getElementById('map'), {
//		center: new google.maps.LatLng(52.5377, 13.4281),
//		//zoom: 17, // (good for one street)
//		zoom: 15,
//		mapTypeId: google.maps.MapTypeId.HYBRID,
//		overviewMapControl: true,
//		overviewMapControlOptions: {
//			opened: true
//		},
//		styles: 
//		[
//			{
//				"stylers": [
//					{ "invert_lightness": true },
//					{ "gamma": 0.93 },
//					{ "lightness": -39 },
//					{ "saturation": -81 }
//				]
//			},{
//				"featureType": "road",
//				"stylers": [
//					{ "saturation": -40 },
//					{ "lightness": 4 },
//					{ "gamma": 1.04 }
//				]
//			}
//		]
//	});

	var map = new google.maps.Map(document.getElementById('map'), {
		center: new google.maps.LatLng(52.5377, 13.4281), //good value for seeing both streets
//		center: new google.maps.LatLng(52.5400, 13.4129), // Schönhauser Allee 42
//		zoom: 17, // (good for one street)
		zoom: 15, // good for an overview
		mapTypeId: google.maps.MapTypeId.ROADMAP,
		overviewMapControl: true,
		overviewMapControlOptions: {
			opened: true
		},
		styles: 
		[
			{
				"stylers": [
					{ "invert_lightness": true },
					{ "gamma": 0.93 },
					{ "lightness": -39 },
					{ "saturation": -81 }
				]
			},{
				"featureType": "road",
				"stylers": [
					{ "saturation": -40 },
					{ "lightness": 4 },
					{ "gamma": 1.04 }
				]
			}
		]
	});

	// google.maps.event.addListener(map, "click", function(){
	//    alert("Map clicked");
	// });

	//  IMPORT DATA FOR SCHOENHAUSER ALLEE FROM EXTERNAL FILE

	var importFunction3 = d3.dsv(";","text/csv");

	//  Load the station data. When the data comes back, create an overlay.
	importFunction3("prenzl_schoen_allee.csv", function(data) {
		//    console.log(data);

		//  CREATE COLOR SCALE FOR DATAPOINTS

		var height_min = d3.min(data, function(d) {
			return d.lumen/d.watt;
			console.log(d.lumen/d.watt);
		});
		var height_max = d3.max(data, function(d) {
			return d.lumen/d.watt;
		});

		var height_scale = d3.scale.linear()
		.domain([height_min,height_max])
//		.range(["#ff0000","#FFD700"]); // yellow/red
//		.range(["#0080ff","#d2efff"]); // blue
		.range(["#ff6200","#d8ef00"]); // yellowgreen/red
//		.range(["#f00","#50fc04"]); // green/red


		//    CREATE OVERLAY FOR GOOGLE MAPS

		var overlay = new google.maps.OverlayView();

		// Add the container when the overlay is added to the map.
		overlay.onAdd = function() {
			var layer = d3.select(this.getPanes().overlayMouseTarget).append("div")
			.attr("class", "datapoints");


			//    DRAW DATAPOINTS FOR LIGHTS WITH SVG

			// Draw each marker as a separate SVG element. We could use a single SVG, but what size would it have?
			overlay.draw = function() {
				var projection = this.getProjection()
				var padding = 10;

				//    var test = layer.selectAll("svg").data(data);
				//    console.log("test "+test);

				var radius = function(d) {return d.lumen/10000+3;};

				var marker = layer.selectAll("svg")
				.data(data)
				.each(transform) // update existing markers
				.enter().append("svg:svg")
				.each(transform)
				.attr("class", "marker")
//				.style("height", function(d) {return (d.lumen/10000+3)*4;})
//				.style("width", function(d) {return (d.lumen/10000+3)*4;});
				.style("height", 25)
				.style("width", 20)
//				.style("height", 25)
//				.style("width", 20)
//				.style("fill", function(d) {return height_scale(d.lumen/d.watt);})
				

				var tooltip = d3.select("body").append("div")
				.attr("class", "tooltip")
				.style("opacity", 0);


				marker.append("svg:path")

//				.attr("d", "M38,40.125c2.719,0,4.922,2.203,4.922,4.921c0,2.677-1.613,2.989-1.916,5.907c0,0.272-0.22,0.492-0.492,0.492h-5.027 c-0.272,0-0.492-0.22-0.492-0.492h-0.001c-0.302-2.918-1.915-3.23-1.915-5.907C33.078,42.328,35.281,40.125,38,40.125M40.461,51.937c0.272,0,0.492,0.22,0.492,0.492s-0.22,0.492-0.492,0.492h-4.922c-0.272,0-0.492-0.22-0.492-0.492 s0.22-0.492,0.492-0.492H40.461 M40.461,53.414c0.272,0,0.492,0.22,0.492,0.492s-0.22,0.492-0.492,0.492h-4.922 c-0.272,0-0.492-0.22-0.492-0.492s0.22-0.492,0.492-0.492H40.461 M39.969,54.89c0,0.543-0.441,0.984-0.984,0.984h-1.969 c-0.543,0-0.984-0.441-0.984-0.984H39.969 M38,39c-3.335,0-6.047,2.711-6.047,6.046c0,1.675,0.548,2.636,1.028,3.485 c0.409,0.719,0.762,1.342,0.889,2.499c0.012,0.258,0.085,0.498,0.205,0.71c-0.098,0.209-0.154,0.442-0.154,0.688 c0,0.267,0.064,0.516,0.179,0.738c-0.114,0.223-0.179,0.471-0.179,0.738c0,0.693,0.438,1.286,1.051,1.516 C35.21,56.327,36.036,57,37.016,57h1.969c0.98,0,1.806-0.672,2.042-1.578c0.614-0.23,1.052-0.823,1.052-1.516 c0-0.267-0.066-0.516-0.18-0.738c0.114-0.223,0.18-0.472,0.18-0.738c0-0.246-0.056-0.479-0.154-0.687 c0.12-0.214,0.193-0.456,0.204-0.713c0.129-1.156,0.482-1.777,0.889-2.498c0.482-0.848,1.03-1.811,1.03-3.485 C44.047,41.711,41.336,39,38,39L38,39z") // that's the bulb
				.attr("d", "M13.316,15.942l-1.205,0.701l-0.001,1.389l0.002,6.734H7.267v-6.734 l-0.001-1.389l-1.202-0.7c-2.28-1.329-3.642-3.667-3.643-6.254c0-4.008,3.262-7.266,7.268-7.268 c4.008,0.001,7.268,3.26,7.268,7.268C16.954,12.275,15.597,14.612,13.316,15.942z")
//				.attr("transform", "translate(-27, -34)") // good for bulb
				.style("fill", function(d) {return height_scale(d.lumen/d.watt);})
				.style("fill-opacity", .4)
				.style("stroke-width", 4)
				.style("stroke-opacity", .4)
				.style("stroke", function(d) {return height_scale(d.lumen/d.watt);})
//				;
//
//
//				// Add the VISIBLE circle
//				marker.append("svg:circle")
////				.attr("r", radius)
//				.attr("r", 5)
//				.attr("cx", function(d) {return (d.lumen/10000+3)*2;})
//				.attr("cy", function(d) {return (d.lumen/10000+3)*2;})
//				.attr("class", "circle")
//
//				.style("position", "absolut")
//				.style("fill", function(d) {return height_scale(d.lumen/d.watt);})
//				.style("opacity", 0.6)
//				.style("stroke-width", function(d) {return d.lumen/10000+6;})
//				.style("stroke-opacity", .3)
//				.style("stroke", function(d) {return height_scale(d.lumen/d.watt);})

				.on("mouseover", function(d) {
					tooltip.html(d)
					d3.select(this).attr("class", "circleHighlighted").transition().duration(100)

					d3.select("#tooltip").select("#name_lamp").text(d.name_lamp)
					d3.select("#tooltip").select("#installed").text(d.installed)
					d3.select("#tooltip").select("#bulb").text(d.bulb)
					d3.select("#tooltip").select("#type_bulb").text("Natrium vapor discharge lamp")
					d3.select("#tooltip").select("#watt").text(d.watt + " W")
					d3.select("#tooltip").select("#energy_consumption").text(d.energy_consumption + " kWh")
					d3.select("#tooltip").select("#lumen").text(d.lumen + " lm")
					d3.select("#tooltip").select("#lumen_per_watt").text(d.lumen/d.watt + " lm/W")
					d3.select("#tooltip").select("#energy_efficiency").text(d.energy_efficiency)
					d3.select("#tooltip").select("#powered").text("From 9.46pm to 4.34am")
					d3.select("#tooltip").classed("hidden", false).transition().duration(500);
//					d3.select("#tooltip").style("opacity", .9).transition().duration(100);
				})

				.on("mouseout", function() {
//					d3.select(this).classed("circleHighlighted", false).transition().duration(500);
//					d3.select("#tooltip").style("opacity", 0)
					d3.select("#tooltip").classed("hidden", true).transition().duration(500);
				})


				function transform(d) {
					//          console.log("d "+d);
					data_point = new google.maps.LatLng(normalize(d.lat), normalize(d.lon));
					data_point_projected = projection.fromLatLngToDivPixel(data_point);
					return d3.select(this)
					.style("left", (data_point_projected.x - padding) + "px")
					.style("top", (data_point_projected.y - padding) + "px");
				}

				function normalize(coordinate) {
					// console.log("coordinate: "+coordinate);
					if (coordinate > 1000) return coordinate / 100000;
					else return coordinate;
				}

				function getColor(value){
					//          console.log("value "+value);
					if (value > 4) return "red";
					else return "green";
				}
			};
		};

		// Bind our overlay to the map…
		overlay.setMap(map);
	});


	//  TRAFFIC VISIALIZATION


	//  IMPORT DATA FOR TRAFFIC FROM EXTERNAL FILE

	var importFunction1 = d3.dsv(";","text/csv");

	//  Load the station data. When the data comes back, create an overlay.
	importFunction1("mobility_night.csv", function(data) {
		//     console.log(data);

		//  CREATE COLOR SCALE FOR DATAPOINTS

		var height_min = d3.min(data, function(d) {
			return d.car_night;
//			var param = "cars";
//			return d[param];
		});
		var height_max = d3.max(data, function(d) {
			return d.car_night;
		});

		var height_scale = d3.scale.linear()
		.domain([height_min,height_max])
		.range(["#76ff00","#fd4501"]);



		//    CREATE OVERLAY FOR GOOGLE MAPS

		var overlay = new google.maps.OverlayView();

		// Add the container when the overlay is added to the map.
		overlay.onAdd = function() {
			var layer = d3.select(this.getPanes().overlayLayer).append("div")
			.attr("class", "datapoints");

			//    DRAW DATAPOINTS FOR heightS WITH SVG

			// Draw each marker as a separate SVG element. We could use a single SVG, but what size would it have?
			overlay.draw = function() {
				var projection = this.getProjection()
				var padding = 10;
				var radius = 10;

				//    var test = layer.selectAll("svg").data(data);
				//    console.log("test "+test);

				var marker = layer.selectAll("svg")
				.data(data)
				.each(transform) // update existing markers
				.enter().append("svg:svg")
				.each(transform)
				.attr("class", "marker")
				.style("height", 25)
				.style("width", 29)
				.style("opacity", 0.3);

				//				// Add a circle.
				//				marker.append("svg:circle")
				//				//          .attr("r", function(d) {return d.height*1.1;})
				//				.attr("r", radius)
				//				.attr("cx", padding)
				//				.attr("cy", padding)
				//				.attr("class", "circle")
				//				// .on("click", function(){alert("test")}) // toDo: make markers clickable
				//				.style("fill", function(d) {return height_scale(d.cars);});

				//				marker.append("svg:rect")
				//				.attr("x", 0)
				//				.attr("y", 0)
				//				//				.attr("rx", 3)
				//				//				.attr("ry", 3)
				//				.attr("width", 15)
				//				.attr("height", 15)
				//				.style("fill", function(d) {return height_scale(d.cars);});

				marker.append("svg:path")

				.attr("d", "M37.543,31.023v-9.71h-2.219l-1.646-7.199H16.325l-1.646,7.199h-2.219v9.71l-0.137,0.594h0.137v0.965h1.673v3.304h5v-3.304 h11.737v3.304h5v-3.304h1.672v-0.965h0.137L37.543,31.023z M17.541,27.143h-3.417v-3.417h3.417V27.143z M30.738,30.324H19.266v-1 h11.472V30.324z M30.738,27.447H19.266v-1h11.472V27.447z M30.738,24.571H19.266v-1h11.472V24.571z M31.939,21.313H28.99 c-0.012-0.08-0.023-0.161-0.023-0.246c0-0.826,0.674-1.499,1.5-1.499s1.498,0.673,1.498,1.499 C31.965,21.152,31.953,21.233,31.939,21.313z M30.465,18.568c-1.377,0-2.498,1.121-2.498,2.499c0,0.085,0.016,0.164,0.023,0.246 H16.731l1.188-5.199h14.166l1.188,5.199h-0.334c0.008-0.082,0.025-0.161,0.025-0.246C32.965,19.689,31.844,18.568,30.465,18.568z M35.881,27.143h-3.416v-3.417h3.416V27.143z")
				.attr("transform", "translate(-10, -13)")
				.style("stroke-width", 2)
				//				.style("stroke", "steelblue")
				.style("fill", function(d) {return height_scale(d.car_night);});

				function transform(d) {
					//          console.log("d "+d);
					data_point = new google.maps.LatLng(normalize(d.lat), normalize(d.lon));
					data_point_projected = projection.fromLatLngToDivPixel(data_point);
					return d3.select(this)
					.style("left", (data_point_projected.x - padding) + "px")
					.style("top", (data_point_projected.y - padding) + "px");
				}

				function normalize(coordinate) {
					// console.log("coordinate: "+coordinate);
					if (coordinate > 1000) return coordinate / 100000;
					else return coordinate;
				}

			};
		};

		// Bind our overlay to the map…
		overlay.setMap(map);
	});


	////      Additional triangle just for pleasure
	////      marker.append("svg:path")
	////          .attr('d', function(d) { 
	////            var x = padding -10, y = padding - 15;
	////            return 'M ' + x +' '+ y + ' l 4 4 l -8 0 z'; //M: startcenter, l: draw line after walk, z: close shape
	////          })
	////          .attr("fill-opacity", "0.5")
	////          .style("fill", "#00d8ff");
	//
	////      Another shape for pleasure
	////      marker.append("svg:path")
	////        .attr('d', function(d) { 
	////          var x = padding -10 , y = padding - 5;
	////          return 'M ' + x +' '+ y + ' l 5 5 l -5 5 l -5 -5 z';
	////        })
	////        .attr("fill-opacity", "0.5")
	////        .style("fill", "#00d8ff");
	//

</script>
</body>
</html>